<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plateforme Chauffeur Yassir Premium </title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: url('IMG_20260223_103833.jpg') no-repeat center center fixed;
    background-size: cover;
    color: white;
}

.container {
    max-width: 550px;
    margin: auto;
    padding: 25px;
}

.card {
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(20px);
    border-radius: 25px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.6);
}

.status {
    display: inline-block;
    margin-top: 10px;
    padding: 6px 15px;
    border-radius: 50px;
    background: #00ff9d;
    color: black;
    font-size: 12px;
    font-weight: bold;
}

.section-title {
    margin: 20px 0 10px;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.promo-grid {
    display: grid;
    gap: 20px;
}

.promo-item {
    position: relative;
    border-radius: 15px;
    overflow: hidden;
}

.loc-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #00ff9d;
    color: black;
    padding: 8px 14px;
    border-radius: 30px;
    font-size: 12px;
    font-weight: bold;
    text-decoration: none;
    z-index: 2;
}

.promo-item img {
    width: 100%;
    display: block;
    border-radius: 15px;
}
 .driver-photo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #00c853;
    margin: 10px auto;
    display: block;
}
</style>
</head>

<body>

<div class="container">

    <div class="card">
    <h3 id="driverTitle">Chauffeur Yassir</h3>
    <img id="driverPhoto" src="" alt="Photo chauffeur" class="driver-photo">
    <h2 id="driverName">Chargement chauffeur...</h2>
    <p>ID : <span id="driverId">---</span></p>
    <div class="status" id="driverStatus"></div>
</div>

<div class="section-title">Offres GOLD</div>
    <div class="promo-grid" id="goldAds"></div>

    <div class="section-title">Offres SILVER</div>
    <div class="promo-grid" id="silverAds"></div>

    <div class="section-title">Offres BRONZE</div>
    <div class="promo-grid" id="bronzeAds"></div>
    
    
    <div class="section-title">‚õΩ Pompes Conventionn√©es</div>

    <button onclick="findNearestPump()" style="
    padding:15px;
    border-radius:30px;
    background:#00ff9d;
    border:none;
    font-weight:bold;
    width:100%;
    margin-bottom:20px;
    cursor:pointer;">
    üöó Trouver la pompe la plus proche
    </button>

</div>

<!-- POPUP BRONZE -->
<div id="bronzePopup" style="
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.9);
z-index:9999;
justify-content:center;
align-items:center;
flex-direction:column;
">

    <img id="popupImage" src="" style="
        max-width:90%;
        max-height:75%;
        border-radius:20px;
        margin-bottom:20px;
    ">

    <a id="callSellerBtn" href="#" style="
        background:#00ff9d;
        color:black;
        padding:15px 25px;
        border-radius:30px;
        font-weight:bold;
        text-decoration:none;
        font-size:16px;
    ">
        üìû Appeler vendeur
    </a>

</div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
// ================= CONFIG =================

const SHEET_ID = "1QD2yljHw-O2ijbhqDgqShKlEnSEFYWz6oRzUb4ENO8Q";
const sheetBase = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;

const params = new URLSearchParams(window.location.search);
const driverId = params.get("id");

// ================= LOAD CSV =================

function loadCSV(sheetName, callback){
    Papa.parse(sheetBase + sheetName, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: results => callback(results.data)
    });
}

// ================= DRIVER =================

loadCSV("chauffeurs", chauffeurs => {

    if(!driverId){
        document.getElementById("driverId").innerText = "Non fourni";
        return;
    }

    const driver = chauffeurs.find(c => 
        (c.id && c.id.trim() === driverId.trim()) ||
        (c.ID && c.ID.trim() === driverId.trim())
    );

    if(driver){
        document.getElementById("driverName").innerText = driver.nom + " " + driver.prenom;
        document.getElementById("driverStatus").innerText = driver.statut;
        document.getElementById("driverId").innerText = driver.id || driver.ID;
          // ‚úÖ AJOUT PHOTO
        if(driver.photo_url){
            document.getElementById("driverPhoto").src = driver.photo_url;
        }
    } else {
        document.getElementById("driverName").innerText = "Chauffeur non trouv√©";
        document.getElementById("driverId").innerText = driverId;
    }
});

    
// ================= ADS =================

function showAds(sheet, elementId){

    loadCSV(sheet, data => {

        const container = document.getElementById(elementId);
        container.innerHTML = "";

        data.forEach(ad => {

            if(!ad.image_URL) return;

            const promo = document.createElement("div");
            promo.className = "promo-item";

            // ================= GOLD & SILVER =================
            if(sheet !== "publicites_bronze"){

                promo.innerHTML = `
                    <a href="${ad.localisation}" class="loc-btn" target="_blank">
                        üìç Localiser
                    </a>
                    <a href="${ad.lien_boutique}" target="_blank">
                        <img src="${ad.image_URL}" alt="${ad.nom}">
                    </a>
                `;

            } 
            // ================= BRONZE =================
            else {

                promo.innerHTML = `
                    <img src="${ad.image_URL}" 
                         alt="${ad.nom}" 
                         style="cursor:pointer"
                         onclick="openBronzePopup('${ad.image_URL}','${ad.telephone}')">
                `;
            }

            container.appendChild(promo);
        });

    });
}

showAds("publicites_gold","goldAds");
showAds("publicites_silver","silverAds");
showAds("publicites_bronze","bronzeAds");

// =============================
// üî• LIEN CSV PUBLI√â DIRECT
// =============================

const PUMP_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXrcDrR2-JCU7DLzRH1C8wTozquzcEhmjHCVzWQR16M2c5jpdqI3fwLKb0fJgChgJHy6Vx5OuRRxFO/pub?gid=1310866954&single=true&output=csv";

let pumpsData = [];

// Charger CSV publi√©
Papa.parse(PUMP_CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        pumpsData = results.data;
        console.log("Pompes charg√©es PRO :", pumpsData);
    }
});

// =============================
// üìè Calcul distance
// =============================

function getDistance(lat1, lon1, lat2, lon2) {

    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

// =============================
// üöó Trouver pompe la plus proche
// =============================

function findNearestPump() {

    if (!pumpsData.length) {
        alert("Les donn√©es des pompes ne sont pas encore charg√©es.");
        return;
    }

    if (!navigator.geolocation) {
        alert("La g√©olocalisation n'est pas support√©e.");
        return;
    }

    navigator.geolocation.getCurrentPosition(position => {

        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        let nearest = null;
        let minDistance = Infinity;

        pumpsData.forEach(pump => {

            if (!pump.latitude || !pump.longitude) return;

            const lat = parseFloat(pump.latitude.trim());
            const lon = parseFloat(pump.longitude.trim());

            if (isNaN(lat) || isNaN(lon)) return;

            const distance = getDistance(userLat, userLon, lat, lon);

            if (distance < minDistance) {
                minDistance = distance;
                nearest = pump;
            }
        });

        if (nearest) {

            let mapsUrl = nearest.lien_maps && nearest.lien_maps.trim() !== ""
                ? nearest.lien_maps.trim()
                : `https://www.google.com/maps/dir/?api=1&destination=${nearest.latitude},${nearest.longitude}`;

            alert(
                "üöó Pompe la plus proche : " + nearest.nom_station +
                "\nüìç Ville : " + nearest.ville +
                "\nüìè Distance : " + minDistance.toFixed(2) + " km"
            );

            window.open(mapsUrl, "_blank");

        } else {
            alert("Aucune pompe valide trouv√©e.");
        }

    }, () => {
        alert("Activez la localisation pour trouver la pompe la plus proche.");
    });
}

function openBronzePopup(imageUrl, phone){

    document.getElementById("popupImage").src = imageUrl;

    if(phone && phone.trim() !== ""){
        document.getElementById("callSellerBtn").href = "tel:" + phone;
        document.getElementById("callSellerBtn").style.display = "inline-block";
    } else {
        document.getElementById("callSellerBtn").style.display = "none";
    }

    document.getElementById("bronzePopup").style.display = "flex";
}

// Fermer popup quand on clique en dehors
document.getElementById("bronzePopup").addEventListener("click", function(e){
    if(e.target.id === "bronzePopup"){
        this.style.display = "none";
    }
});

</script>

</body>
</html>
