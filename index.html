<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plateforme Chauffeur Yassir Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: url('IMG_20260223_103833.jpg') no-repeat center center fixed;
    background-size: cover;
    color: white;
}

.container {
    max-width: 550px;
    margin: auto;
    padding: 25px;
}

.card {
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(20px);
    border-radius: 25px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.6);
}

.status {
    display: inline-block;
    margin-top: 10px;
    padding: 6px 15px;
    border-radius: 50px;
    background: #00ff9d;
    color: black;
    font-size: 12px;
    font-weight: bold;
}

.section-title {
    margin: 20px 0 10px;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.promo-grid {
    display: grid;
    gap: 20px;
}

.promo-item {
    position: relative;
    border-radius: 15px;
    overflow: hidden;
}

.loc-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #00ff9d;
    color: black;
    padding: 8px 14px;
    border-radius: 30px;
    font-size: 12px;
    font-weight: bold;
    text-decoration: none;
    z-index: 2;
}

.promo-item img {
    width: 100%;
    display: block;
    border-radius: 15px;
}

.driver-photo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #00c853;
    margin: 10px auto;
    display: block;
}

/* Badge GOLD anim√© */
.gold-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: linear-gradient(45deg, gold, orange);
    color: black;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    z-index: 3;
    animation: glow 1.5s infinite alternate;
}

/* Glow animation */
@keyframes glow {
    from { box-shadow: 0 0 5px gold; }
    to { box-shadow: 0 0 20px orange; }
}

/* Boutons GOLD en bas */
.gold-btns {
    margin-top: 10px;
    display: flex;
    gap: 10px;
}

.gold-btns a {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    text-align: center;
    font-weight: bold;
    text-decoration: none;
    color: black;
    transition: transform 0.2s, box-shadow 0.2s;
}

.gold-btns a:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px gold;
}

.gold-btns .whatsapp { background: #25D366; color: white; }
.gold-btns .call { background: #00ff9d; }
.gold-btns .shop { background: #FFD700; color: black; }
</style>
</head>

<body>

<div class="container">

    <div class="card">
        <h3 id="driverTitle">Chauffeur Yassir</h3>
        <img id="driverPhoto" src="" alt="Photo chauffeur" class="driver-photo">
        <h2 id="driverName">Chargement chauffeur...</h2>
        <p>ID : <span id="driverId">---</span></p>
        <div class="status" id="driverStatus"></div>
    </div>

    <div class="section-title">Offres GOLD</div>
    <div class="promo-grid" id="goldAds"></div>

    <div class="section-title">Offres SILVER</div>
    <div class="promo-grid" id="silverAds"></div>

    <div class="section-title">Offres BRONZE</div>
    <div class="promo-grid" id="bronzeAds"></div>
    
   <!-- ================= PARTENAIRES CONVENTIONN√âS ================= -->

<div class="section-title">ü§ù Partenaires Conventionn√©s</div>
<div id="categoryButtons" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px;"></div>

<!-- POPUP BRONZE -->
<div id="bronzePopup" style="
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.9);
z-index:9999;
justify-content:center;
align-items:center;
flex-direction:column;
">
    <img id="popupImage" src="" style="
        max-width:90%;
        max-height:75%;
        border-radius:20px;
        margin-bottom:20px;
    ">
    <a id="callSellerBtn" href="#" style="
        background:#00ff9d;
        color:black;
        padding:15px 25px;
        border-radius:30px;
        font-weight:bold;
        text-decoration:none;
        font-size:16px;
    ">üìû Appeler vendeur</a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
// ================= CONFIG =================
const SHEET_ID = "1QD2yljHw-O2ijbhqDgqShKlEnSEFYWz6oRzUb4ENO8Q";
const sheetBase = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;
const params = new URLSearchParams(window.location.search);
const driverId = params.get("id");

// ================= LOAD CSV =================
function loadCSV(sheetName, callback){
    Papa.parse(sheetBase + sheetName, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: results => callback(results.data)
    });
}

// ================= DRIVER =================
loadCSV("chauffeurs", chauffeurs => {
    if(!driverId){
        document.getElementById("driverId").innerText = "Non fourni";
        return;
    }
    const driver = chauffeurs.find(c => 
        (c.id && c.id.trim() === driverId.trim()) ||
        (c.ID && c.ID.trim() === driverId.trim())
    );
    if(driver){
        document.getElementById("driverName").innerText = driver.nom + " " + driver.prenom;
        document.getElementById("driverStatus").innerText = driver.statut;
        document.getElementById("driverId").innerText = driver.id || driver.ID;
        if(driver.photo_url){ document.getElementById("driverPhoto").src = driver.photo_url; }
    } else {
        document.getElementById("driverName").innerText = "Chauffeur non trouv√©";
        document.getElementById("driverId").innerText = driverId;
    }
});

// ================= ADS =================
function showAds(sheet, elementId){
    loadCSV(sheet, data => {
        const container = document.getElementById(elementId);
        container.innerHTML = "";
        data.forEach(ad => {
            if(!ad.image_URL) return;
            const promo = document.createElement("div");
            promo.className = "promo-item";

            // GOLD
            if(sheet === "publicites_gold"){
                promo.innerHTML = `
                    <div class="gold-badge">‚≠ê GOLD PARTENAIRE</div>
                    <a href="${ad.localisation}" class="loc-btn" target="_blank">üìç Localiser</a>
                    <a href="${ad.lien_boutique}" target="_blank">
                        <img src="${ad.image_URL}" alt="${ad.nom}">
                    </a>
                    <div class="gold-btns">
                        <a href="tel:${ad.telephone}" class="call">üìû Appeler</a>
                        <a href="https://wa.me/${ad.telephone}" target="_blank" class="whatsapp">üí¨ WhatsApp</a>
                        <a href="${ad.lien_boutique}" target="_blank" class="shop">üõí Voir boutique</a>
                    </div>
                `;
            }
            // SILVER
            else if(sheet === "publicites_silver"){
                promo.innerHTML = `
                    <a href="${ad.localisation}" class="loc-btn" target="_blank">üìç Localiser</a>
                    <a href="${ad.lien_boutique}" target="_blank">
                        <img src="${ad.image_URL}" alt="${ad.nom}">
                    </a>
                `;
            }
            // BRONZE
            else {
                promo.innerHTML = `
                    <img src="${ad.image_URL}" alt="${ad.nom}" style="cursor:pointer"
                        onclick="openBronzePopup('${ad.image_URL}','${ad.telephone}')">
                `;
            }

            container.appendChild(promo);
        });
    });
}

showAds("publicites_gold","goldAds");
showAds("publicites_silver","silverAds");
showAds("publicites_bronze","bronzeAds");

// ================= POPUP BRONZE =================
function openBronzePopup(imageUrl, phone){
    document.getElementById("popupImage").src = imageUrl;
    if(phone && phone.trim() !== ""){
        document.getElementById("callSellerBtn").href = "tel:" + phone;
        document.getElementById("callSellerBtn").style.display = "inline-block";
    } else {
        document.getElementById("callSellerBtn").style.display = "none";
    }
    document.getElementById("bronzePopup").style.display = "flex";
}
document.getElementById("bronzePopup").addEventListener("click", function(e){
    if(e.target.id === "bronzePopup"){ this.style.display = "none"; }
});

// =============================
// üì¶ Charger partenaires
// =============================

let partenairesData = [];

loadCSV("partenaires_conventionnes", data => {
    partenairesData = data;
    generateCategoryButtons();
});

// =============================
// üé® Ic√¥nes intelligentes
// =============================

function getCategoryIcon(category){

    const cat = category.toLowerCase();

    if(cat.includes("restaurant")) return "üçΩÔ∏è";
    if(cat.includes("station")) return "‚õΩ";
    if(cat.includes("garage")) return "üõ†Ô∏è";
    if(cat.includes("lavage")) return "üöó";
    if(cat.includes("pneum")) return "üõû";
    if(cat.includes("hotel")) return "üè®";
    if(cat.includes("boutique")) return "üè¨";
    if(cat.includes("superette")) return "üõí";
    if(cat.includes("pharmacie")) return "üíä";
    if(cat.includes("cafe")) return "‚òï";

    return "üìç";
}

// =============================
// üéØ G√©n√©rer boutons automatiquement
// =============================

function generateCategoryButtons(){

    const container = document.getElementById("categoryButtons");
    container.innerHTML = "";

    const categories = [...new Set(
        partenairesData.map(p => p.categorie).filter(Boolean)
    )];

    categories.forEach(cat => {

        const btn = document.createElement("button");

        const icon = getCategoryIcon(cat);

        btn.innerHTML = icon + " " + cat + " le plus proche";

        btn.style.padding = "12px";
        btn.style.borderRadius = "25px";
        btn.style.border = "none";
        btn.style.cursor = "pointer";
        btn.style.background = "#00ff9d";
        btn.style.fontWeight = "bold";
        btn.style.boxShadow = "0 5px 15px rgba(0,0,0,0.3)";
        btn.style.transition = "0.2s";

        btn.onmouseover = () => btn.style.transform = "scale(1.05)";
        btn.onmouseout = () => btn.style.transform = "scale(1)";

        btn.onclick = () => findNearestByCategory(cat);

        container.appendChild(btn);
    });
}

function getDistance(lat1, lon1, lat2, lon2){

    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}
    
// =============================
// üìç Trouver le plus proche par cat√©gorie
// =============================

function findNearestByCategory(category){

    if (!navigator.geolocation) {
        alert("‚ùå G√©olocalisation non support√©e par votre appareil.");
        return;
    }

    navigator.geolocation.getCurrentPosition(

        function(position){

            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            let nearest = null;
            let minDistance = Infinity;

            partenairesData.forEach(partner => {

                if(!partner.categorie) return;
                if(partner.categorie.toLowerCase().trim() !== category.toLowerCase().trim()) return;
                if(!partner.latitude || !partner.longitude) return;

                const lat = parseFloat(partner.latitude.replace(",", ".").trim());
                const lon = parseFloat(partner.longitude.replace(",", ".").trim());

                if(isNaN(lat) || isNaN(lon)) return;

                const distance = getDistance(userLat, userLon, lat, lon);

                if(distance < minDistance){
                    minDistance = distance;
                    nearest = partner;
                }
            });

            if(!nearest){
                alert("‚ö†Ô∏è Aucun partenaire trouv√© pour : " + category);
                return;
            }

            const lat = parseFloat(nearest.latitude.replace(",", ".").trim());
            const lon = parseFloat(nearest.longitude.replace(",", ".").trim());

            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;

            alert(
                "üèÜ " + category + " le plus proche : " + nearest.nom +
                "\nüìè Distance : " + minDistance.toFixed(2) + " km"
            );

            // Redirection FORC√âE Android
            setTimeout(() => {
                window.location.assign(mapsUrl);
            }, 500);

        },

        function(error){

            if(error.code === 1){
                alert("‚ùå Autorisation localisation refus√©e.");
            }
            else if(error.code === 2){
                alert("‚ùå Position indisponible.");
            }
            else if(error.code === 3){
                alert("‚ùå Temps d√©pass√© pour la localisation.");
            }
            else{
                alert("‚ùå Erreur inconnue localisation.");
            }

        },

        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }

    );
}



      
    }, () => {
        alert("Activez la localisation.");
    });
}



</script>

</body>
</html>
