<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plateforme Chauffeur Yassir Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: url('IMG_20260223_103833.jpg') no-repeat center center fixed;
    background-size: cover;
    color: white;
}

.container {
    max-width: 550px;
    margin: auto;
    padding: 25px;
}

.card {
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(20px);
    border-radius: 25px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.6);
}

.section-title {
    margin: 20px 0 10px;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

button {
    padding: 12px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    background: #00ff9d;
    font-weight: bold;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: 0.2s;
}

button:hover {
    transform: scale(1.05);
}
</style>
</head>

<body>

<div class="container">

<div class="section-title">ü§ù Partenaires Conventionn√©s</div>
<div id="categoryButtons" style="display:flex; flex-wrap:wrap; gap:10px;"></div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
// ================= CONFIG =================

const SHEET_ID = "1QD2yljHw-O2ijbhqDgqShKlEnSEFYWz6oRzUb4ENO8Q";
const sheetBase = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;

// ================= LOAD CSV =================

function loadCSV(sheetName, callback){
    Papa.parse(sheetBase + sheetName, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: results => callback(results.data)
    });
}

// ================= DISTANCE =================

function getDistance(lat1, lon1, lat2, lon2){

    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

// ================= PARTENAIRES =================

let partenairesData = [];

loadCSV("partenaires_conventionnes", data => {

    partenairesData = data.filter(p => p.latitude && p.longitude);

    if(partenairesData.length === 0){
        alert("‚ö†Ô∏è Aucun partenaire charg√©.");
        return;
    }

    generateCategoryButtons();
});

// ================= ICONES =================

function getCategoryIcon(category){

    const cat = category.toLowerCase();

    if(cat.includes("restaurant")) return "üçΩÔ∏è";
    if(cat.includes("pompe") || cat.includes("station")) return "‚õΩ";
    if(cat.includes("garage")) return "üõ†Ô∏è";
    if(cat.includes("superette")) return "üõí";

    return "üìç";
}

// ================= BOUTONS =================

function generateCategoryButtons(){

    const container = document.getElementById("categoryButtons");
    container.innerHTML = "";

    const categories = [...new Set(
        partenairesData.map(p => p.categorie.trim())
    )];

    categories.forEach(cat => {

        const btn = document.createElement("button");

        btn.innerHTML = getCategoryIcon(cat) + " " + cat + " le plus proche";

        btn.onclick = () => findNearestByCategory(cat);

        container.appendChild(btn);
    });
}

// ================= LOCALISATION =================

function findNearestByCategory(category){

    if(partenairesData.length === 0){
        alert("Donn√©es partenaires non charg√©es.");
        return;
    }

    if (!navigator.geolocation) {
        alert("‚ùå G√©olocalisation non support√©e.");
        return;
    }

    navigator.geolocation.getCurrentPosition(

        function(position){

            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            let nearest = null;
            let minDistance = Infinity;

            partenairesData.forEach(partner => {

                if(!partner.categorie) return;

                if(partner.categorie.trim().toLowerCase() !== category.trim().toLowerCase()) return;

                const lat = parseFloat(partner.latitude.replace(",", "."));
                const lon = parseFloat(partner.longitude.replace(",", "."));

                if(isNaN(lat) || isNaN(lon)) return;

                const distance = getDistance(userLat, userLon, lat, lon);

                if(distance < minDistance){
                    minDistance = distance;
                    nearest = partner;
                }
            });

            if(!nearest){
                alert("Aucun partenaire trouv√©.");
                return;
            }

            alert(
                "üèÜ " + nearest.nom +
                "\nüìè Distance : " + minDistance.toFixed(2) + " km"
            );

            const mapsUrl =
                `https://www.google.com/maps/dir/?api=1&destination=${nearest.latitude},${nearest.longitude}&travelmode=driving`;

            window.location.href = mapsUrl;
        },

        function(error){
            alert("‚ö†Ô∏è Activez la localisation dans votre t√©l√©phone.");
        },

        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }

    );
}

</script>

</body>
</html>
